jQuery(document).ready(function(l){"use strict";l(window).load(function(){var c={attached_files:""},t=function(e,t,a){var s=e.target.files;if(!(s.length<=0)){var r=new FormData,i="#"+t+" ",o=e.target.files[0].name,n=0;1<=s.length&&l.each(s,function(){this.size>parseInt(task_breakerProjectSettings.max_file_size)&&n++}),1<=n?alert("There was an error uploading your file. File size exceeded the allowed number of bytes per request."):(l(i+".tasbreaker-file-attached").html(o),l.each(s,function(e,t){r.append(e,t)}),"null"!=typeof a&&l.each(a,function(e,t){r.append(e,t)}),r.append("action","task_breaker_transactions_request"),r.append("method","task_breaker_transaction_task_file_attachment"),r.append("nonce",task_breakerProjectSettings.nonce),l(i+".taskbreaker-upload-error").remove(),l(i+".taskbreaker-upload-error-text-helper").removeClass("active"),l(i+".taskbreaker-upload-success-text-helper").removeClass("active"),l.ajax({url:task_breakerAjaxUrl,type:"POST",data:r,cache:!1,dataType:"json",processData:!1,contentType:!1,success:function(e,t,a){void 0===e.error?0!==e?"fail"===e.message?(c.attached_files="",l(i+".tb-file-attachment-progress").parent().append('<div class="taskbreaker-upload-error">'+e.response+"</div>"),l(i+".taskbreaker-upload-error-text-helper").addClass("active"),l(i+".taskbreaker-upload-success-text-helper").removeClass("active")):(c.attached_files=e.file,l(i+".taskbreaker-upload-error").remove(),l(i+".taskbreaker-upload-error-text-helper").removeClass("active"),l(i+".taskbreaker-upload-success-text-helper").addClass("active")):(l(i+".taskbreaker-upload-error-text-helper").addClass("active"),l(i+".taskbreaker-upload-success-text-helper").removeClass("active"),l(i+".tb-file-attachment-progress").parent().append('<div class="taskbreaker-upload-error">The application did not received any response from the server. Try uploading smaller files.</div>'),c.attached_files=""):console.log("File attachment errors debug: "+e.error)},error:function(e,t,a){console.log("File attachment errors debug: "+t)},xhr:function(){var e=l.ajaxSettings.xhr(),t=0,a="0%";return e.upload&&(l(i+".tb-file-attachment-progress-wrap").addClass("active"),l("#task_breaker-submit-btn").attr("disabled",!0),l("#task_breaker-edit-btn").attr("disabled",!0),e.upload.addEventListener("progress",function(e){e.lengthComputable&&(l("progress").attr({value:e.loaded,max:e.total}),"number"==typeof(t=e.loaded/e.total*100)&&(a=Math.floor(t)+"%",l(i+".tb-file-attachment-progress-movable").css({width:a}),l(i+".taskbreaker-upload-progress-value").html(a)))},!1)),e},complete:function(){console.log("finished"),l("#task_breaker-submit-btn").removeAttr("disabled"),l("#task_breaker-edit-btn").removeAttr("disabled")}}))}},n=new(Backbone.View.extend({id:0,project_id:task_breakerProjectSettings.project_id,page:1,priority:-1,current_page:1,max_page:1,min_page:1,total:0,show_completed:"no",total_pages:0})),d=new(Backbone.View.extend({el:"body",model:n,search:"",template:"",events:{"click .task_breaker-project-tab-li-item-a":"switchView","click .next-page":"next","click .prev-page":"prev","submit #task-breaker-search-task-form":"searchTasks","change #task_breaker-task-filter-select":"filter"},switchView:function(e,t){if(e){var a=l(e.currentTarget);if(-1!==l.inArray(a.attr("id"),["task_breaker-project-edit-tab","task_breaker-project-edit","task_breaker-project-add-new"]))return!1}c.attached_files="",l(".tasbreaker-file-attached").html("No Files Selected."),l(".tb-file-attachment-progress-wrap").removeClass("active"),l("#task_breaker-project-edit-tab").css("display","none"),l("#task_breaker-project-add-new").css("display","none"),l(".task_breaker-project-tab-li-item").removeClass("active"),l(".task_breaker-project-tab-content-item").removeClass("active");var s="";if(e){var r=l(e.currentTarget);s=r.attr("data-content"),r.parent().addClass("active"),l("div[data-content="+s+"]").addClass("active")}else l(t).addClass("active"),s=l(t).attr("data-content"),l("a[data-content="+s+"]").parent().addClass("active")},hideFilters:function(){l("#task_breaker-tasks-filter").hide()},showFilters:function(){l("#task_breaker-tasks-filter").show()},searchTasks:function(e){var t=l("#task_breaker-task-search-field").val();return 0===t.length?location.href="#tasks":location.href="#tasks/search/"+encodeURI(t),!1},filter:function(e){this.model.priority=e.currentTarget.value,"tasks"!=Backbone.history.getFragment()?location.href="#tasks":this.render()},next:function(e){e.preventDefault();var t=this.model.page;t<this.model.max_page&&(this.model.page=++t,location.href="#tasks/page/"+this.model.page)},prev:function(e){e.preventDefault();var t=this.model.page;t>this.model.min_page&&(this.model.page=--t,location.href="#tasks/page/"+this.model.page)},single:function(e){this.progress(!0);var t=this;this.template="single_task_index",this.renderTask(function(e){t.progress(!1),"fail"==e.message&&l("#task_breaker-project-tasks").html("<p class='info' id='message'>"+e.message_long+"</p>"),e.html&&l("#task_breaker-project-tasks").html(e.html)})},showEditForm:function(e){var s=this,t="";"undefined"!=typeof tinymce&&(t=tinymce.get("task_breakerTaskEditDescription")),this.progress(!0),t?t.setContent(""):l("#task_breakerTaskEditDescription").val(""),l(".task_breaker-project-tab-content-item").removeClass("active"),l(".task_breaker-project-tab-li-item").removeClass("active"),l("a#task_breaker-project-edit-tab").css("display","block").parent().addClass("active"),l("#task_breaker-project-edit-context").addClass("active"),l("#task_breakerTaskId").attr("disabled",!0).val("loading..."),l("#task_breakerTaskEditTitle").attr("disabled",!0).val("loading..."),l("#task_breaker-task-edit-select-id").attr("disabled",!0),this.model.id=e,this.renderTask(function(e){if(s.progress(!1),e.task){var t=e.task,a="";"undefined"!=typeof tinymce&&(a=tinymce.get("task_breakerTaskEditDescription")),l("#task_breakerTaskId").val(t.id).removeAttr("disabled"),l("#task_breakerTaskEditTitle").val(t.title).removeAttr("disabled"),l("#js-edit-taskbreaker-deadline-field").val(t.deadline.replace("-","")),a?a.setContent(t.description):l("#task_breakerTaskEditDescription").val(t.description),l("#task-user-assigned-edit").val(""),document.getElementById("task-user-assigned-edit")&&(document.getElementById("task-user-assigned-edit").options.length=0),l.each(t.assign_users_meta.members_stack,function(e,t){var a=document.createElement("option");a.value=t.ID,a.text=t.display_name,a.selected="selected",document.getElementById("task-user-assigned-edit").appendChild(a)}),s.autoSuggestMembers(l("#task-user-assigned-edit"),!0,t),l("#task_breaker-task-edit-select-id").val(t.priority).change().removeAttr("disabled"),l("#task-breaker-form-file-attachment-edit-field").removeAttr("disabled"),t.meta?l.each(t.meta,function(e,t){if("file_attachment"===t.meta_key){var a="";l("#taskbreaker-file-attachment-edit .tasbreaker-file-attached").html(t.meta_value),c.attached_files=t.meta_value,a+='<a href="#" title="Click to remove file attachment" data-attachment="'+t.meta_value+'">&times;</a>',l("#taskbreaker-unlink-file-btn").html(a)}}):(l("#taskbreaker-file-attachment-edit .tasbreaker-file-attached").html("No files attached"),l("#taskbreaker-unlink-file-btn a").remove())}})},renderTask:function(t){l.ajax({url:ajaxurl,method:"get",dataType:"json",data:{action:"task_breaker_transactions_request",method:"task_breaker_transaction_fetch_task",id:this.model.id,project_id:this.model.project_id,template:this.template,nonce:task_breakerProjectSettings.nonce},success:function(e){t(e)}})},render:function(){var t=this;this.progress(!0),l.ajax({url:ajaxurl,method:"get",dataType:"json",data:{action:"task_breaker_transactions_request",method:"task_breaker_transaction_fetch_task",id:this.model.id,project_id:this.model.project_id,page:this.model.page,search:this.search,priority:this.model.priority,template:"render_tasks",show_completed:this.model.show_completed,nonce:task_breakerProjectSettings.nonce},success:function(e){t.progress(!1),"success"==e.message&&(e.task.stats&&(n.max_page=e.task.stats.max_page,n.min_page=e.task.stats.min_page),l("#task_breaker-project-tasks").html(e.html)),0===e.task.length&&l("#task_breaker-project-tasks").html('<div class="task-breaker-message danger">No tasks found. Try different keywords and filters.</div>')},error:function(){}})},initialize:function(){},progress:function(e){var t="none",a=1;e&&(t="block",a=.25),l("#task_breaker-preloader").css({display:t}),l("#task_breaker-project-tasks").css({opacity:a})},updateStats:function(e){var t=null,a=null;e.status&&(t=e.status.priority,a=e.status.task_status),a&&l("#task-details-status").text(a).removeClass("open close").addClass(a.toLowerCase()),t&&l("#task-details-priority").text(t).removeClass("normal high critical").addClass(t.toLowerCase()),l(".task_breaker-total-tasks").text(e.total),l(".task_breaker-remaining-tasks-count").text(e.remaining),l(".task-progress-completed").text(e.completed),l(".task-progress-percentage-label > span").text(e.progress),l(".task-progress-percentage").css({width:Math.ceil(e.completed/e.total*100)+"%"})},autoSuggestMembers:function(a,e,t){if(a){a.select2({maximumInputLength:20,placeholder:"Type member's name...",allowClear:!0,minimumResultsForSearch:1/0,minimumInputLength:2,tag:!0,ajax:{data:function(e){var t={action:"task_breaker_transactions_request",method:"task_breaker_transactions_user_suggest",nonce:task_breakerProjectSettings.nonce,group_id:task_breakerProjectSettings.current_group_id,term:e.term,user_id_collection:0};return a.val()&&(t.user_id_collection=a.val()),t},url:task_breakerAjaxUrl,delay:250,cache:!0},templateResult:function(e){if(e.avatar)var t=l('<span><img class="result-template-avatar" src="'+e.avatar+'" alt="s" />'+e.text+"</span>");return t}})}}}));(new(Backbone.Router.extend({routes:{tasks:"index","tasks/dashboard":"dashboard","tasks/settings":"settings","tasks/completed":"completed_tasks","tasks/add":"add","tasks/edit/:id":"edit","tasks/page/:page":"next","tasks/view/:id":"view_task","tasks/search/:search_keyword":"search"},view:d,model:n,index:function(){this.view.switchView(null,"#task_breaker-project-tasks-context"),this.model.page=1,this.model.id=0,this.model.show_completed="no",this.view.search="",this.view.render()},dashboard:function(){this.view.switchView(null,"#task_breaker-project-dashboard-context")},settings:function(){this.view.switchView(null,"#task_breaker-project-settings-context")},add:function(){this.view.switchView(null,"#task_breaker-project-add-new-context"),l("#task_breaker-project-add-new").css("display","block"),l("#task-user-assigned").val(""),l("#js-edit-taskbreaker-deadline-field").val(""),this.view.autoSuggestMembers(l("#task-user-assigned"),!0,null),tinymce.editors.task_breakerTaskDescription&&tinymce.editors.task_breakerTaskDescription.setContent("")},completed_tasks:function(){this.view.switchView(null,"#task_breaker-project-tasks-context"),this.model.show_completed="yes",this.view.render()},edit:function(e){this.view.showEditForm(e),l("#task_breaker-edit-task-message").html("")},next:function(e){this.model.page=e,this.view.render()},view_task:function(e){this.model.id=e,this.view.single(e),this.view.switchView(null,"#task_breaker-project-tasks-context")},search:function(e){this.model.page=1,this.model.id=0,this.view.search=e,this.view.render()}}))).on("route",function(e){"view_task"===e?this.view.hideFilters():this.view.showFilters()}),Backbone.history.start(),l("#task_breaker-submit-btn").click(function(e){e.preventDefault();var t=l(this);t.attr("disabled",!0),t.text("Loading ...");var a="",s=tinymce.get("task_breakerTaskDescription");a=s?s.getContent():l("#task_breakerTaskDescription").val(),l.ajax({url:ajaxurl,data:{action:"task_breaker_transactions_request",method:"task_breaker_transaction_add_ticket",description:a,deadline:l("#js-add-taskbreaker-deadline-field").val(),title:l("#task_breakerTaskTitle").val(),milestone_id:l("#task_breakerTaskMilestone").val(),priority:l("select#task_breaker-task-priority-select").val(),nonce:task_breakerProjectSettings.nonce,project_id:task_breakerTaskConfig.currentProjectId,user_id:task_breakerTaskConfig.currentUserId,user_id_collection:l("select#task-user-assigned").val(),file_attachments:c.attached_files},method:"post",success:function(e){parseInt(l(".task_breaker-total-tasks").text().trim()),parseInt(l(".task_breaker-remaining-tasks-count").text().trim());"success"===e.message?(t.text("Save Task"),t.removeAttr("disabled"),l("#task_breakerTaskDescription").val(""),l("#task_breakerTaskTitle").val(""),d.updateStats(e.stats),location.href="#tasks/view/"+e.response.id):(l("#task_breaker-add-task-message").html('<p class="error">'+e.response+"</p>").show().addClass("error"),t.text("Save Task"),t.removeAttr("disabled"))},statusCode:{500:function(){l("#task_breaker-add-task-message").html('<p class="error">Unexpected Error (500)</p>').show().addClass("error"),t.text("Save Task"),t.removeAttr("disabled")}},error:function(e,t){l("#task_breaker-add-task-message").html('<p class="error">Unexpected Error Encountered During Request</p>').show().addClass("error")}})}),l("#task-breaker-form-file-attachment-field").on("change",function(e){t(e,"taskbreaker-file-attachment-add")}),c.attached_files="",l("#task_breaker-edit-btn").click(function(e){e.preventDefault();var a=l(this);a.attr("disabled",!0),a.text("Loading ...");var t=tinymce.get("task_breakerTaskEditDescription"),s={description:t?t.getContent():l("#task_breakerTaskEditDescription").val(),deadline:l("#js-edit-taskbreaker-deadline-field").val(),nonce:task_breakerProjectSettings.nonce,project_id:task_breakerTaskConfig.currentProjectId,user_id:task_breakerTaskConfig.currentUserId,action:"task_breaker_transactions_request",method:"task_breaker_transaction_edit_ticket",title:l("#task_breakerTaskEditTitle").val(),milestone_id:l("#task_breakerTaskMilestone").val(),id:l("#task_breakerTaskId").val(),priority:l('select[name="task_breaker-task-edit-priority"]').val(),user_id_collection:l("select#task-user-assigned-edit").val(),file_attachments:c.attached_files};l.ajax({url:ajaxurl,data:s,method:"post",success:function(e){var t="<p class='task-breaker-message success'>Task successfully updated <a href='#tasks/view/"+e.id+"'>&#65515; View</a></p>";"fail"===e.message&&"no_changes"!==e.type&&(t="<p class='task-breaker-message danger'>There was an error updating the task. All fields are required.</a></p>"),"fail"===e.message&&"unauthorized"===e.type&&(t="<p class='task-breaker-message danger'>You are not allowed to modify this task. Only group project administrators and group projects moderators are allowed.</a></p>"),l("#task_breaker-edit-task-message").html(t).show(),a.attr("disabled",!1),a.text("Update Task"),l("html, body").animate({scrollTop:l("#task_breaker-edit-task-message").offset().top-300},100)},error:function(){console.log("An Error Occured [task_breaker.js]#311")}})}),l("#task-breaker-form-file-attachment-edit-field").on("change",function(e){console.log("test");t(e,"taskbreaker-file-attachment-edit",{edit_file_attachment:"yes"})}),l("#task_breaker-project").on("click","#taskbreaker-unlink-file-btn > a",function(e){e.preventDefault(),confirm("Are you sure you want to delete this file attachment? This process is not reversible.")&&console.log("deleting file...");var t=l("#task_breakerTaskId").val();l(".tasbreaker-file-attached").html("Deleting file attachment..."),l.ajax({method:"POST",url:task_breakerAjaxUrl,data:{nonce:task_breakerProjectSettings.nonce,ticket_id:t,action:"task_breaker_transactions_request",method:"task_breaker_transaction_delete_ticket_attachment"},success:function(e){l(".tasbreaker-file-attached").html("No files attached"),l("#taskbreaker-unlink-file-btn > a").remove(),c.attached_files=""}})}),l("body").on("click","#task_breaker-delete-btn",function(){if(confirm("Are you sure you want to delete this task? This action is irreversible")){var a=l(this),e={action:"task_breaker_transactions_request",method:"task_breaker_transaction_delete_ticket",id:parseInt(n.id),project_id:parseInt(n.project_id),nonce:task_breakerProjectSettings.nonce};d.progress(!0),a.text("Deleting ..."),l.ajax({url:ajaxurl,data:e,method:"post",success:function(e){if(d.progress(!1),d.updateStats(e.stats),"fail"===e.message){var t="<p class='task-breaker-message danger'>"+e.message_text+"</p>";return l("#task_breaker-edit-task-message").html(t).show(),!1}location.href="#tasks",d.switchView(null,"#task_breaker-project-tasks-context"),a.text("Delete")},error:function(){d.progress(!1),a.text("Delete")}})}}),l("body").on("click","#updateTaskBtn",function(){var t=l(this);t.attr("disabled","disabled");var e=n.id,a=l("#task-comment-content").val(),s=l("#task_breaker-task-priority-update-select").val(),r=l("input[name=task_commment_completed]:checked").val(),i=parseInt(n.project_id);if(0!==e){d.progress(!0);var o={action:"task_breaker_transactions_request",method:"task_breaker_transaction_add_comment_to_ticket",ticket_id:e,priority:s,details:a,completed:r,project_id:i,nonce:task_breakerProjectSettings.nonce};l.ajax({url:ajaxurl,data:o,method:"post",success:function(e){t.attr("disabled",!1),d.progress(!1),l("#task-comment-content").val(""),l("#task-lists").append(e.result),"yes"===r&&(l("#ticketStatusInProgress").attr("disabled",!0).attr("checked",!1),l("#ticketStatusComplete").attr("disabled",!0).attr("checked",!1),l("#comment-completed-radio").addClass("hide"),l("#ticketStatusCompleteUpdate").attr("disabled",!1).attr("checked",!0),l("#ticketStatusReOpenUpdate").attr("disabled",!1),l("#task_breaker-comment-completed-radio").removeClass("hide")),"reopen"===r&&(l("#ticketStatusInProgress").attr("disabled",!1).attr("checked",!0),l("#ticketStatusComplete").attr("disabled",!1).attr("checked",!1),l("#comment-completed-radio").removeClass("hide"),l("#ticketStatusCompleteUpdate").attr("disabled",!0).attr("checked",!1),l("#ticketStatusReOpenUpdate").attr("disabled",!0),l("#task_breaker-comment-completed-radio").addClass("hide")),d.updateStats(e.stats)},error:function(){t.attr("disabled",!1),d.progress(!1)}})}}),l("body").on("click","a.task_breaker-delete-comment",function(e){if(e.preventDefault(),!confirm("Are you sure you want to delete this comment? This action is irreversible. "))return!1;var t=l(this),a={action:"task_breaker_transactions_request",method:"task_breaker_transaction_delete_comment",comment_id:parseInt(l(this).attr("data-comment-id")),nonce:task_breakerProjectSettings.nonce};d.progress(!0),l.ajax({url:ajaxurl,data:a,method:"post",success:function(e){d.progress(!1),"success"==e.message?t.parent().parent().parent().parent().fadeOut(function(){l(this).remove()}):this.error()},error:function(){d.progress(!1),t.parent().append('<p class="error">Transaction Error: There was an error trying to delete this comment.</p>')}})}),l("body").on("click","#task_breakerUpdateProjectBtn",function(){var t=l(this),e="",a=tinymce.get("task_breakerProjectContent");e=a?a.getContent():l("#task_breakerProjectContent").val();var s={action:"task_breaker_transactions_request",method:"task_breaker_transactions_update_project",id:parseInt(l("#task_breaker-project-id").val()),title:l("#task_breaker-project-name").val(),content:e,group_id:parseInt(l("select[name=task_breaker-project-assigned-group]").val()),nonce:task_breakerProjectSettings.nonce};t.attr("disabled",!0).text("Updating ..."),d.progress(!0),l(".task_breaker-project-updated").remove(),l.ajax({url:ajaxurl,data:s,method:"post",success:function(e){d.progress(!1),t.attr("disabled",!1).text("Update Project"),"success"===e.message?(l("article .entry-header > .entry-title").text(l("#task_breaker-project-name").val()),t.parent().parent().prepend('<div id="message" class="task_breaker-project-updated success updated"><p>Project details successfully updated.</p></div>'),location.reload()):"authentication_error"===e.type?t.parent().parent().prepend('<div id="message" class="task_breaker-project-updated error updated"><p>Only group administrators and moderators can update the project settings.</p></div>'):t.parent().parent().prepend('<div id="message" class="task_breaker-project-updated success updated"><p>There was an error saving the project. All fields are required.</p></div>'),d.progress(!1),setTimeout(function(){l(".task_breaker-project-updated").fadeOut()},3e3)},error:function(){alert("connection failure")}})}),l("body").on("click","#task_breakerDeleteProjectBtn",function(){if(confirm("Are you sure you want to delete this project? All the tickets under this project will be deleted as well. This action cannot be undone.")){var e={action:"task_breaker_transactions_request",method:"task_breaker_transactions_delete_project",id:l("#task_breaker-project-id").val(),nonce:task_breakerProjectSettings.nonce};l(this).text("Deleting..."),l.ajax({url:ajaxurl,method:"post",data:e,success:function(e){"success"==e.message?window.location=e.redirect:this.error()},error:function(){alert("There was an error trying to delete this post. Try again later.")}})}}),l(".js-taskbreaker-task-deadline").datetimepicker({minDate:-20,dateFormat:"mm-dd-yy"})})});
//# sourceMappingURL=task-breaker.min.js.map